library(phyloseq)
library(ANCOMBC)
library(microbiome)
library(dplyr)
library(tibble)
library(writexl)

#### ANCOMBC2 at genus and ASV level in case control dataset ####
# genus level
# aggregate data to genus level
ps <- readRDS('phyloseq_casecontrol_alpha_fin.rds')
genus_data_t = aggregate_taxa(ps, "Genus")
genus_data_t #59 genera
head(genus_data_t@tax_table)
physeq_g <- genus_data_t
save(physeq_g, file = "physeq_genus_aggregated_fin.Rda")
# prev cut at 0.2
model_adj <- ancombc2(data = physeq_g, assay_name = "counts", tax_level = NULL,
                      fix_formula = "Skin.Type + Age.years + Father.education +
                        BMI.Group + Mother.education + Family.income +
                        Gestational.Age + Birth.Methods + ATOPY.Mother + ATOPY.Father + Exclusive.Breastfeed + 
                        Feeding.Habit + DNA.concentration + Lesi.Non.Lesi", 
                      p_adj_method = "holm", pseudo_sens = TRUE,
                      prv_cut = 0.2, s0 = 0.05, struc_zero = FALSE, neg_lb = TRUE, alpha = 0.05, 
                      iter_control = list(tol = 0.01, max_iter = 20, verbose = FALSE))

#extract relevant vars for AD cases vs controls
#lfc, q values and whether it passed the ss test
# Filter the data to include only rows where both conditions are TRUE
res_df <- as.data.frame(model_adj$res)
filtered_data <- res_df %>%
  dplyr::filter(`diff_Lesi.Non.LesiLesional` == TRUE, `passed_ss_Lesi.Non.LesiLesional` == TRUE)
# only Arcobacter and Gluconobacter... passed at prevalence 0.20 and genus aggregation

# Group by 'taxon' report lfc, se and q
result_df <- filtered_data %>%
  dplyr::group_by(taxon) %>%
  dplyr::summarize(
    lfc = `lfc_Lesi.Non.LesiLesional`,
    se = `se_Lesi.Non.LesiLesional`,
    q = `q_Lesi.Non.LesiLesional`,
    .groups = "drop"
  )

#save output in excel file
write_xlsx(result_df, "ANCOMBC2_casecontrol_fin.xlsx")

# ASV level #
#couple ASVs with names
colnames(ps@tax_table)[1]
colnames(ps@tax_table)[1] <- "Domain"
ps <- microbiome::add_besthit(ps)
head(ps@tax_table)

# unadjusted ASV
out = ancombc2(data = ps, assay_name = "counts", tax_level = NULL,
               fix_formula = "Lesi.Non.Lesi", 
               p_adj_method = "holm", pseudo_sens = TRUE,
               prv_cut = 0.2, s0 = 0.05, struc_zero = FALSE, neg_lb = TRUE, alpha = 0.05, 
               iter_control = list(tol = 0.01, max_iter = 20, verbose = FALSE))
res_df <- as.data.frame(out$res)
filtered_data <- res_df %>%
  dplyr::filter(`diff_Lesi.Non.LesiLesional` == TRUE, `passed_ss_Lesi.Non.LesiLesional` == TRUE)

# adjusted ASVs
adjusted_asv = ancombc2(data = ps, assay_name = "counts", tax_level = NULL,
                        fix_formula = "Skin.Type + sex + Age.years + Father.education +
                 BMI.Group + Mother.education + ATOPY.Mother + ATOPY.Father + Family.income +
                 Gestational.Age + Birth.Methods + Exclusive.Breastfeed + 
                 Feeding.Habit + DNA.concentration + Lesi.Non.Lesi", 
                        p_adj_method = "holm", pseudo_sens = TRUE,
                        prv_cut = 0.2, s0 = 0.05, struc_zero = FALSE, neg_lb = TRUE, alpha = 0.05, 
                        iter_control = list(tol = 0.01, max_iter = 20, verbose = FALSE))
res_df <- as.data.frame(out$res)
filtered_data <- res_df %>%
  dplyr::filter(`diff_Lesi.Non.LesiLesional` == TRUE, `passed_ss_Lesi.Non.LesiLesional` == TRUE)

# Group by 'taxon' report lfc, se and q
result_df <- filtered_data %>%
  dplyr::group_by(taxon) %>%
  dplyr::summarize(
    lfc = `lfc_Lesi.Non.LesiLesional`,
    se = `se_Lesi.Non.LesiLesional`,
    q = `q_Lesi.Non.LesiLesional`,
    .groups = "drop"
  )
#save in excel file
write_xlsx(result_df, "ANCOMBC2_casecontrol_ASV_fin.xlsx")

# make a figure
positive_color <- "#5f6f52"  # Green from pres
negative_color <- "#c45555"  # Red from pres
df_fig_AD = result_df %>%
  dplyr::arrange(desc(lfc)) %>%
  dplyr::mutate(direction = ifelse(lfc > 0, "Positive LFC", "Negative LFC"))
df_fig_AD$taxon = factor(df_fig_AD$taxon, levels = df_fig_AD$taxon)
df_fig_AD$direction = factor(df_fig_AD$direction, 
                             levels = c("Positive LFC", "Negative LFC"))

fig_AD = df_fig_AD %>%
  ggplot(aes(x = taxon, y = lfc, fill = direction)) + 
  geom_bar(stat = "identity", width = 0.7, color = "black", 
           position = position_dodge(width = 0.4)) +
  geom_errorbar(aes(ymin = lfc - se, ymax = lfc + se), 
                width = 0.2, position = position_dodge(0.05), color = "black") + 
  labs(x = NULL, y = "Log fold change", 
       title = "Differentially abundant ASVs in AD cases compared to controls") + 
  scale_fill_manual(values = c("Positive LFC" = positive_color, "Negative LFC" = negative_color)) +
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5, size = 18),
        panel.grid.minor = element_blank(),  # Remove minor gridlines
        panel.grid.major = element_blank(),  # Remove major gridlines
        axis.text.x = element_text(angle = 75, hjust = 1, size = 14,
                                   color = df_fig_AD$color),
        axis.text.y = element_text(size = 14))
png("ANCOMBC2_prev02_AD_ASV.png", width = 1200, height = 600)
plot(fig_AD)
dev.off()


